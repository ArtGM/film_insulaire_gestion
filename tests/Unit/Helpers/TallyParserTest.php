<?php

use Fifig\Volunteer\Infrastructure\TallyPayloadParser;

it('should parse a payload', function () {
    $payload = <<<JSON
{"fields":[{"key":"question_DqVG0j","label":"PrÃ©nom","type":"INPUT_TEXT","value":"Arthur"},{"key":"question_laNEVp","label":"Nom","type":"INPUT_TEXT","value":"Test"},{"key":"question_o9AjlX","label":"âœ‰ï¸ E-mail","type":"INPUT_EMAIL","value":"dev+test@test.fr"},{"key":"question_bZOeRL","label":"ðŸ§‘â€âš•ï¸ NumÃ©ro de sÃ©curitÃ© sociale","type":"INPUT_TEXT","value":"1234567890123"},{"key":"question_RWz98p","label":"ðŸ“ž TÃ©lÃ©phone","type":"INPUT_PHONE_NUMBER","value":"+33612345678"},{"key":"question_Ar8pRD","label":"ðŸŽ‚AnnÃ©e de naissance","type":"INPUT_TEXT","value":"1977"},{"key":"question_GerPY2","label":"ðŸ  Adresse","type":"TEXTAREA","value":"2 avenue foch 17000 La Rochelle"},{"key":"question_OQAN8p","label":"Adresse Ã  Groix pendant le festival (si diffÃ©rente)","type":"TEXTAREA","value":null},{"key":"question_VpZ6vE","label":"ðŸ†˜ Personne Ã  contacter en cas d'urgence ","type":"INPUT_TEXT","value":null},{"key":"question_PRAqvd","label":"tÃ©lÃ©phone","type":"INPUT_PHONE_NUMBER","value":null},{"key":"question_EqPOvq","label":" ðŸ‘• Taille T-shirt (Ã  partir de 5 demi journÃ©es)  (XXL dispo en modÃ¨le \"homme\" seulement)","type":"MULTIPLE_CHOICE","value":["5e0172cb-a1f6-4e2f-915d-ea2f7e7e0f28"],"options":[{"id":"6a55c778-93bd-4835-abb1-409e0fbdecb3","text":"S"},{"id":"5e0172cb-a1f6-4e2f-915d-ea2f7e7e0f28","text":"M"},{"id":"f9d19a00-3783-41ef-b900-f8e63129e875","text":"L"},{"id":"ec000bbc-af7e-46f7-aa8c-a155df263965","text":"XL"},{"id":"08fb9e87-6aa8-43b2-97de-735dd8d33bf4","text":"XXL"}]},{"key":"question_Qo0R97","label":"ðŸ‡¬ðŸ‡§ Niveau d'anglais","type":"MULTIPLE_CHOICE","value":["a6e28ac6-772e-4b18-b0dd-7c842519dc7a"],"options":[{"id":"a6e28ac6-772e-4b18-b0dd-7c842519dc7a","text":"IntermÃ©diaire"},{"id":"d3c01e22-f574-429f-9d2d-5420000ef60f","text":"ConfirmÃ©"}]},{"key":"question_9NlZ0Q","label":"ðŸ‡µðŸ‡¹ Niveau de portugais","type":"MULTIPLE_CHOICE","value":null,"options":[{"id":"0540dab5-fbc7-4982-a705-c68496e9b40e","text":"IntermÃ©diaire"},{"id":"cde02497-6616-454a-95f9-abe39eaba14d","text":"ConfirmÃ©"}]},{"key":"question_e5ErOe","label":"ðŸ´â€â˜ ï¸ Niveau de Breton","type":"MULTIPLE_CHOICE","value":null,"options":[{"id":"fa0c24e1-3ffe-4153-992b-112f3f7fd1ea","text":"IntermÃ©diaire"},{"id":"86360b2b-a4b1-48c0-a2d8-1cab4a2500e1","text":"ConfirmÃ©"}]},{"key":"question_2j461A","label":"ðŸ¥— Quelles sont vos contraintes alimentaires ? Si vous ne cochez rien, ce sera de tout&nbsp;!","type":"MULTIPLE_CHOICE","value":["861e4e40-e357-4297-9ae1-a6d87c55fbb1"],"options":[{"id":"dd55e958-8f0b-4728-8635-d45270352aa8","text":"Sans viande"},{"id":"861e4e40-e357-4297-9ae1-a6d87c55fbb1","text":"Sans viande ni poisson"},{"id":"8ce3eb52-3a2c-41ff-8e33-3b5b9c0bc7e2","text":"Rien de particulier"}]},{"key":"question_xVdW4J","label":"ðŸ¤§ Allergies","type":"TEXTAREA","value":null},{"key":"question_RWz9vP","label":"ðŸ¥° Avez-vous unâ€¢e ou des amiâ€¢eâ€¢s avec qui vous souhaiteriez faire partie de la mÃªme Ã©quipe, si c'est possible pour nous&nbsp;?","type":"TEXTAREA","value":null},{"key":"question_o9AjKM","label":"ðŸš¸ Si vous souhaitez bÃ©nÃ©ficier, de l'accueil de vos enfants Ã  lâ€™Ã®le des enfants sur vos crÃ©neaux de bÃ©nÃ©volat, prÃ©cisez leur Ã¢ge:","type":"TEXTAREA","value":null},{"key":"question_GerPXz","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage...","type":"CHECKBOXES","value":null,"options":[{"id":"3e878971-20c9-452e-b1ac-f703cb1a37be","text":"Vendredi 16"},{"id":"bd3a86ca-e465-45de-a66f-f3a9c4787cf1","text":"Samedi 17"},{"id":"f23e91d2-671f-4903-acd6-1a21566670c6","text":"Dimanche 18"},{"id":"77d13ca1-4403-484b-b21f-b33a8aa29d6e","text":"Lundi 19"},{"id":"7743b954-64cc-4d6b-8be4-be2b92b9bd7f","text":"Mardi 20"}]},{"key":"question_GerPXz_3e878971-20c9-452e-b1ac-f703cb1a37be","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage... (Vendredi 16)","type":"CHECKBOXES","value":null},{"key":"question_GerPXz_bd3a86ca-e465-45de-a66f-f3a9c4787cf1","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage... (Samedi 17)","type":"CHECKBOXES","value":null},{"key":"question_GerPXz_f23e91d2-671f-4903-acd6-1a21566670c6","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage... (Dimanche 18)","type":"CHECKBOXES","value":null},{"key":"question_GerPXz_77d13ca1-4403-484b-b21f-b33a8aa29d6e","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage... (Lundi 19)","type":"CHECKBOXES","value":null},{"key":"question_GerPXz_7743b954-64cc-4d6b-8be4-be2b92b9bd7f","label":"ðŸ› ï¸ Avant le Festival&nbsp;du vendredi 16 aoÃ»t au mardi 20 aoÃ»t : travaux divers, nettoyage, amÃ©nagement, installation expositions, mise en place et dÃ©coration du site, signalÃ©tique, secrÃ©tariat, affichage... (Mardi 20)","type":"CHECKBOXES","value":null},{"key":"question_OQANdA","label":"ðŸ“¢ RÃ©union d'accueil des bÃ©nÃ©voles","type":"CHECKBOXES","value":["25dfb0b5-61ee-4c0a-82d1-12257663f4bc"],"options":[{"id":"25dfb0b5-61ee-4c0a-82d1-12257663f4bc","text":"Mardi 20 Ã  17h30, suivi d'un pot dâ€™accueil ðŸ»"}]},{"key":"question_OQANdA_25dfb0b5-61ee-4c0a-82d1-12257663f4bc","label":"ðŸ“¢ RÃ©union d'accueil des bÃ©nÃ©voles (Mardi 20 Ã  17h30, suivi d'un pot dâ€™accueil ðŸ»)","type":"CHECKBOXES","value":true},{"key":"question_VpZ6vl","label":"ðŸŽŠ Pendant le Festival du mercredi 21 aoÃ»t au dimanche 25 aoÃ»t inclus","type":"MATRIX","value":{"631086aa-65fb-452a-87ff-1a1c3a3c6b60":[],"fccb8b26-473e-4394-a071-70f3b24278a7":[],"d57c5861-b4a9-4cb6-893f-41092d94873c":["fd81b928-90bb-4f9c-8256-edf6ea99eb5f","c3a9c9a8-1d63-4103-9496-930f9e458d60","fb73cd37-a8e5-419f-a1ec-17f8008fd808","fa8cbc80-d8ff-469c-9599-11800e309863","7bc5d4e5-3a2b-4dd6-9ec9-cef0252f06d9"],"4a65a77c-d0ea-4a29-a2e1-0edf38723835":["fd81b928-90bb-4f9c-8256-edf6ea99eb5f","c3a9c9a8-1d63-4103-9496-930f9e458d60","fb73cd37-a8e5-419f-a1ec-17f8008fd808","fa8cbc80-d8ff-469c-9599-11800e309863","7bc5d4e5-3a2b-4dd6-9ec9-cef0252f06d9"]},"rows":[{"id":"fccb8b26-473e-4394-a071-70f3b24278a7","text":"Matin"},{"id":"4a65a77c-d0ea-4a29-a2e1-0edf38723835","text":"Midi"},{"id":"631086aa-65fb-452a-87ff-1a1c3a3c6b60","text":"AprÃ¨s-midi"},{"id":"d57c5861-b4a9-4cb6-893f-41092d94873c","text":"Soir"}],"columns":[{"id":"fd81b928-90bb-4f9c-8256-edf6ea99eb5f","text":"Mercredi 21"},{"id":"c3a9c9a8-1d63-4103-9496-930f9e458d60","text":"Jeudi 22"},{"id":"fb73cd37-a8e5-419f-a1ec-17f8008fd808","text":"Vendredi 23"},{"id":"fa8cbc80-d8ff-469c-9599-11800e309863","text":"Samedi 24"},{"id":"7bc5d4e5-3a2b-4dd6-9ec9-cef0252f06d9","text":"Dimanche 25"}]},{"key":"question_J1ReKX","label":"ðŸ”¥En durÃ©e d'implication, vous souhaitez&nbsp;:","type":"MULTIPLE_CHOICE","value":["81384f7f-a466-4c37-b586-220109d01939"],"options":[{"id":"f3b64ea8-9707-42ad-9551-154f3d1b0f97","text":"faire une plage horaire par jour et ainsi bÃ©nÃ©ficier d'un seul repas par jour."},{"id":"81384f7f-a466-4c37-b586-220109d01939","text":"faire deux plages horaires par jour et ainsi bÃ©nÃ©ficier des repas du midi et du soir."},{"id":"f14bc9ed-8032-418e-a864-1737c05d24cd","text":"alterner une ou deux plages par jour, en fonction des besoins du Fifig"}]},{"key":"question_EqPOvL","label":"ðŸ§¹ AprÃ¨s le Festival lundi 28 aoÃ»t et mardi 29 aoÃ»t&nbsp;: rangement, dÃ©montage, nettoyage du site...","type":"CHECKBOXES","value":null,"options":[{"id":"35d62e04-591c-4e88-a5a0-38553b9c20b9","text":"Lundi 28"},{"id":"ec505e1f-9841-493d-98c7-51443ae1b673","text":"Mardi 29"}]},{"key":"question_EqPOvL_35d62e04-591c-4e88-a5a0-38553b9c20b9","label":"ðŸ§¹ AprÃ¨s le Festival lundi 28 aoÃ»t et mardi 29 aoÃ»t&nbsp;: rangement, dÃ©montage, nettoyage du site... (Lundi 28)","type":"CHECKBOXES","value":null},{"key":"question_EqPOvL_ec505e1f-9841-493d-98c7-51443ae1b673","label":"ðŸ§¹ AprÃ¨s le Festival lundi 28 aoÃ»t et mardi 29 aoÃ»t&nbsp;: rangement, dÃ©montage, nettoyage du site... (Mardi 29)","type":"CHECKBOXES","value":null},{"key":"question_aOG4AW","label":"SÃ©lectionnez 3 Ã©quipes que vous aimeriez rejoindre (par ordre de prÃ©fÃ©rences)","type":"MULTI_SELECT","value":["a8abeeed-6f88-4196-975d-18417c7ae5d4","d2669a55-fede-46a6-9e64-45c620ae315c","491773d3-85c4-482b-8af8-c28a142ff163"],"options":[{"id":"1c49f13e-3090-444d-b930-c2acc560beb8","text":"ðŸŽŸï¸ Billetterie: Informations et vente de billets, vente de produits dÃ©rivÃ©s et gestion de caisse, contrÃ´le des entrÃ©es en salles de projections, nettoyage des salles de cinÃ©ma. A Port-Lay et au cinÃ©ma des Familles."},{"id":"491773d3-85c4-482b-8af8-c28a142ff163","text":"ðŸ—žï¸ Communication : RÃ©daction de Â« l'Ã®lot Â» journal quotidien sur la vie du Festival, affichage informatif sur le site. Photos et vidÃ©os."},{"id":"d2669a55-fede-46a6-9e64-45c620ae315c","text":"ðŸ» Bar : Aide au montage, au service, nettoyage et rangement, gestion des caisses et des stocks."},{"id":"a8abeeed-6f88-4196-975d-18417c7ae5d4","text":"ðŸ½ï¸ Restauration (cochez une, deux ou trois options ci-dessous)"},{"id":"3f2c554d-e9a2-495f-ae14-2a0f6f6412fc","text":"ðŸŒ± Team Ã©co-logique :  Information et accompagnement des festivaliers au tri sÃ©lectif et Ã  la vaisselle participative, gestion des poubelles, entretien des toilettes, nettoyage du site."},{"id":"129be744-b188-4e23-bd94-a826b23881bb","text":"ðŸ§º Conciergerie : MÃ©nage dans les hÃ©bergements/invitÃ©s, changement des draps, lessives, logistique petits dÃ©jeuners. (PossibilitÃ© d'Ãªtre logÃ© sur place pour assurer une prÃ©sence permanente)."},{"id":"90c359ee-538b-4553-801a-9584633445eb","text":"ðŸ›º Transports : Accueil des invitÃ©s au bateau, arrivÃ©es et dÃ©parts, transports sur les lieux d'hÃ©bergement. Transport du matÃ©riel. (Connaissance de l'Ã®le et permis indispensable, vÃ©hicule souhaitÃ©)."},{"id":"1f2bc646-6888-4f3b-a5ac-991f21b3111f","text":"ðŸ–¼ï¸ Expositions : Accueil des exposants, rÃ©ception du matÃ©riel, aide au montage (avant festival), accueil du public  y compris sur le stand de la librairie et surveillance des lieux, nettoyage des lieux (pendant festival). DÃ©montage expos, rangement (aprÃ¨s festival)."},{"id":"3769fd75-b8f7-46f1-9c2e-d9816db1f470","text":"ðŸ  Accueil loges : Installation et nettoyage des loges. Accueil des musiciens Ã  leur arrivÃ©e, accompagnement pour les repas, en loge pendant les concerts."},{"id":"c3c1fc2c-4e8b-48d5-bdb2-34ba0c6b65fa","text":"ðŸª½ Volante (Logistique) : Manutention, montage et dÃ©montage des stands et des scÃ¨nes, amÃ©nagement des parkings, rangement de mobilier, petits travaux d'entretien, rÃ©paration du matÃ©riel,  sÃ©curisation de l'accÃ¨s. Travail journÃ©e, soirÃ©e ou nuit. (avant, pendant et aprÃ¨s festival). PossibilitÃ© d'Ãªtre dans l'Ã©quipe volante avant et aprÃ¨s le festival et sur une autre Ã©quipe pendant le festival, merci de la signaler par un 2."}]},{"key":"question_yXyoZd","label":"Choix pour la restauration","type":"CHECKBOXES","value":["2161e51e-0f8e-4479-a50e-17c78c13b70a"],"options":[{"id":"c74fb2e6-aaa4-42d9-800e-cdf30b1a34ed","text":"ðŸ‘¨â€ðŸ³ Cuisine :  PrÃ©parations encadrÃ©es par un.e professionnelâ€¢le"},{"id":"2161e51e-0f8e-4479-a50e-17c78c13b70a","text":"ðŸ¥ª Petite restauration : PrÃ©parations et service en stands (frites, grillades, moules, crÃªpes et galettes, wraps)"},{"id":"f9f0c6fc-b6c8-4736-8487-5c0a3ff2cce1","text":"ðŸ’â€â™‚ï¸ Service : Installation, service des repas, nettoyage, plonge"}]},{"key":"question_yXyoZd_c74fb2e6-aaa4-42d9-800e-cdf30b1a34ed","label":"Choix pour la restauration (ðŸ‘¨â€ðŸ³ Cuisine :  PrÃ©parations encadrÃ©es par un.e professionnelâ€¢le)","type":"CHECKBOXES","value":false},{"key":"question_yXyoZd_2161e51e-0f8e-4479-a50e-17c78c13b70a","label":"Choix pour la restauration (ðŸ¥ª Petite restauration : PrÃ©parations et service en stands (frites, grillades, moules, crÃªpes et galettes, wraps))","type":"CHECKBOXES","value":true},{"key":"question_yXyoZd_f9f0c6fc-b6c8-4736-8487-5c0a3ff2cce1","label":"Choix pour la restauration (ðŸ’â€â™‚ï¸ Service : Installation, service des repas, nettoyage, plonge)","type":"CHECKBOXES","value":false},{"key":"question_laAebV","label":"âš ï¸ Avant de valider votre fiche d'inscription, merci de lire et d'accepter la Charte des BÃ©nÃ©voles (rassurez-vous, y'a qu'une page)","type":"CHECKBOXES","value":["2691c253-1f51-4c4b-bfe7-096043399401"],"options":[{"id":"2691c253-1f51-4c4b-bfe7-096043399401","text":"Je confirme que j'ai pris connaissance de la charte des bÃ©nÃ©voles et que j'y adhÃ¨re."}]},{"key":"question_laAebV_2691c253-1f51-4c4b-bfe7-096043399401","label":"âš ï¸ Avant de valider votre fiche d'inscription, merci de lire et d'accepter la Charte des BÃ©nÃ©voles (rassurez-vous, y'a qu'une page) (Je confirme que j'ai pris connaissance de la charte des bÃ©nÃ©voles et que j'y adhÃ¨re.)","type":"CHECKBOXES","value":true}],"eventId":"48ffe673-6b8e-449e-aea8-21f35f0183f2"}
JSON;

    $expectedPayload = <<<JSON
{"personal_informations":{"firstName":"Arthur","lastName":"Test","email":"dev+test@test.fr","healthNumber":"1234567890123","phoneNumber":"+33612345678","birthYear":"1977","address":"2 avenue foch 17000 La Rochelle","addressGx":null,"sosContact":null,"sosPhone":null,"size":"M","englishLevel":"IntermÃ©diaire","portugeseLevel":null,"bretonLevel":null,"typeOfFood":"Sans viande ni poisson","allergies":null,"friends":null,"childKeeping":null},"disponibility":{"beforeEvent":[],"volunteerMeeting":["Mardi 20 Ã  17h30, suivi d'un pot dâ€™accueil ðŸ»"],"duringEvent":["Mercredi 21: Midi, Soir","Jeudi 22: Midi, Soir","Vendredi 23: Midi, Soir","Samedi 24: Midi, Soir","Dimanche 25: Midi, Soir"],"timeSlot":"faire deux plages horaires par jour et ainsi bÃ©nÃ©ficier des repas du midi et du soir.","afterEvent":[]},"team":{"teamPreferences":["ðŸ—žï¸ Communication : RÃ©daction de Â« l'Ã®lot Â» journal quotidien sur la vie du Festival, affichage informatif sur le site. Photos et vidÃ©os.","ðŸ» Bar : Aide au montage, au service, nettoyage et rangement, gestion des caisses et des stocks.","ðŸ½ï¸ Restauration (cochez une, deux ou trois options ci-dessous)"],"teamFoodChoices":["ðŸ¥ª Petite restauration : PrÃ©parations et service en stands (frites, grillades, moules, crÃªpes et galettes, wraps)"]}}
JSON;


    $parser = new TallyPayloadParser();

    $parsedPayload = $parser->parse($payload);

    expect($parsedPayload)->toMatchArray(
        json_decode($expectedPayload, true, 512, JSON_THROW_ON_ERROR)
    );
});